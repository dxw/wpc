#!/bin/sh
set -e

OLD_DATA=whippet_mysql_data_`pwd | perl -pe 'chomp;s{[^a-zA-Z0-9]}{_}g'`
NEW_DATA=whippet`pwd | perl -pe 's{[^a-zA-Z0-9]}{}g'`_mysql_data

if docker inspect ${OLD_DATA} >/dev/null 2>/dev/null; then
  echo Found old data: ${OLD_DATA}
else
  echo Found no old data to migrate. Exiting.
  exit 1
fi

if docker volume inspect ${NEW_DATA} >/dev/null 2>/dev/null; then
  read -p "Found new data volume (${NEW_DATA}). Are you sure you want to overwrite it? [y/n]" yn
  case $yn in
    [Yy]* ) break;; # do nothing
    * ) echo 'Exiting.'; exit 1;;
  esac
else
  echo 'Found no new data.'
  #TODO: Create the volume
fi

echo 'Migrating ...'

# Dumping
docker stop whippet_mysql2 >/dev/null
docker rm whippet_mysql2 >/dev/null
docker run -d --name=whippet_mysql2 --volumes-from=${OLD_DATA} -e MYSQL_DATABASE=wordpress -e MYSQL_ROOT_PASSWORD=foobar mysql >/dev/null
sleep 5
docker exec whippet_mysql2 mysqldump wordpress -pfoobar > dump.tmp.sql
docker stop whippet_mysql2

# Loading
docker stop whippet_mysql2 >/dev/null
docker rm whippet_mysql2 >/dev/null
docker run -d --name=whippet_mysql2 -v ${NEW_DATA}:/var/lib/mysql -e MYSQL_DATABASE=wordpress -e MYSQL_ROOT_PASSWORD=foobar mysql > /dev/null
sleep 10
echo aaaaaaaaaaaa
docker exec -i whippet_mysql2 mysql -e 'drop database if exists wordpress; create database wordpress'
echo bbbbbbbbbbbb
docker exec -i whippet_mysql2 mysql wordpress -pfoobar < dump.tmp.sql
echo cccccccccccc
docker stop whippet_mysql2

echo 'Finished migration.'

exit 0

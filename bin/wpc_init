#!/bin/sh
set -e

if test ${1}X = X; then
  echo 'Usage: wpc_init name-of-project'
  exit 1
fi

makedir() {
  echo "-> Creating directory ${1}"
  mkdir -p ${1}
}

creating() {
  echo "-> Creating ${1}"
  cat > ${1}
  chmod 755 ${1}
}

makedir bin
makedir setup

REPLACEMENT=`echo ${1} | perl -pe 'chomp;s/[^A-Za-z0-9_-]/_/g'`

creating docker-compose.yml <<'END'
version: "3"

volumes:
  mysql_data_!!!PROJECTNAME!!!:

services:
  mailcatcher:
    image: schickling/mailcatcher
    ports:
      - "1080:1080"

  beanstalk:
    image: schickling/beanstalkd

  mysql:
    image: mysql
    ports:
      - "3306:3306"
    volumes:
      - mysql_data_!!!PROJECTNAME!!!:/var/lib/mysql
    environment:
      MYSQL_DATABASE: wordpress
      MYSQL_ROOT_PASSWORD: foobar

  wordpress:
    image: thedxw/wpc-wordpress
    ports:
      - "80:80"
    links:
      - mysql
      - mailcatcher
      - beanstalk
    volumes:
      - .:/usr/src/app
      - ./wp-content:/var/www/html/wp-content
END

perl -pi -e 's/!!!PROJECTNAME!!!/'${REPLACEMENT}'/g' docker-compose.yml

creating bin/wp <<'END'
#!/bin/sh
set -e

FLAGS=

# Add -t flag iff STDIN is a TTY
if [ -t 0 ]; then
  FLAGS=-t
fi

CONTAINER=`docker-compose ps -q wordpress`

# We can't use docker-compose here because `docker-compose exec` is equivalent
# to `docker exec -ti` and `docker-compose exec -T` is equivalent to
# `docker exec`. There is no docker-compose equivalent to `docker exec -i`.
#
# Issue: https://github.com/docker/compose/issues/3352

docker exec -i ${FLAGS} ${CONTAINER} wp ${@}
END

creating bin/console <<'END'
#!/bin/sh
set -e

exec docker-compose exec wordpress bash
END

creating bin/setup <<'END'
#!/bin/sh
set -e

`dirname $0`/../setup/external.sh
docker-compose exec wordpress /usr/src/app/setup/internal.sh
END

creating setup/external.sh <<'END'
#!/bin/sh
set -e

whippet deps install
END

creating setup/internal.sh <<'END'
#!/bin/sh
set -e

wp core install --skip-email --admin_user=admin --admin_password=admin --admin_email=admin@localhost.invalid --url=http://localhost --title=Site
# wp theme activate ...
# wp plugin activate ...
END

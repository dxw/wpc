#!/bin/sh
set -e

if test ${1}X = X; then
  echo 'Usage: wpc_init name-of-project'
  echo '  --multisite: Make it a multisite installation'
  exit 1
fi

if test ${2}X = X && test ${1} = --multisite; then
  echo 'Usage: wpc_init name-of-project'
  echo '  --multisite: Make it a multisite installation'
  exit 1
fi

MULTISITE=false
if test ${1} = --multisite; then
  MULTISITE=true
  shift
fi

if test X${2} = X--multisite; then
  MULTISITE=true
fi

makedir() {
  echo "-> Creating directory ${1}"
  mkdir -p ${1}
}

new_or_overwrite()
{
  if test -f ${1}; then
    echo "The file ${1} already exists. Do you want to overwrite it? (y/n) "
    read REPLY
    _REPLY=`echo ${REPLY} | tr y Y | cut -b1`
    if test ${_REPLY}X != YX; then
      return 1
    fi
  fi
  return 0
}

creating_noexec() {
  echo "-> Creating ${1}"
  cat > ${1}
  chmod 644 ${1}
}

creating() {
  creating_noexec ${1}
  chmod 755 ${1}
}

makedir bin
makedir setup
makedir setup/content

REPLACEMENT=`echo ${1} | sed -e 's/[^A-Za-z0-9_-]/_/g'`

if new_or_overwrite docker-compose.yml; then
  creating_noexec docker-compose.yml <<'END'
version: "3"

volumes:
  mysql_data_!!!PROJECTNAME!!!:

services:
  mailcatcher:
    image: schickling/mailcatcher
    ports:
      - "1080:1080"

  beanstalk:
    image: schickling/beanstalkd
    ports:
      - "11300:11300"

  beanstalkd_console:
    image: agaveapi/beanstalkd-console
    ports:
      - "2080:80"
    environment:
      BEANSTALKD_HOST: beanstalk
      BEANSTALKD_PORT: 11300

  mysql:
    image: mysql
    ports:
      - "3306:3306"
    volumes:
      - mysql_data_!!!PROJECTNAME!!!:/var/lib/mysql
    environment:
      MYSQL_DATABASE: wordpress
      MYSQL_ROOT_PASSWORD: foobar

  wordpress:
    image: thedxw/wpc-wordpress
    ports:
      - "80:80"
    links:
      - mysql
      - mailcatcher
      - beanstalk
    volumes:
      - .:/usr/src/app
      - ./wp-content:/var/www/html/wp-content
END
  sed -i.bak -e 's/!!!PROJECTNAME!!!/'${REPLACEMENT}'/g' docker-compose.yml
  rm docker-compose.yml.bak
fi

if new_or_overwrite bin/wp; then
  creating bin/wp <<'END'
#!/bin/sh
set -e

FLAGS=

# Add -t flag iff STDIN is a TTY
if [ -t 0 ]; then
  FLAGS=-t
fi

CONTAINER=`docker-compose ps -q wordpress`

# We can't use docker-compose here because `docker-compose exec` is equivalent
# to `docker exec -ti` and `docker-compose exec -T` is equivalent to
# `docker exec`. There is no docker-compose equivalent to `docker exec -i`.
#
# Issue: https://github.com/docker/compose/issues/3352

docker exec -i ${FLAGS} ${CONTAINER} wp "${@}"
END
fi

if new_or_overwrite bin/console; then
  creating bin/console <<'END'
#!/bin/sh
set -e

exec docker-compose exec wordpress bash
END
fi

if new_or_overwrite bin/setup; then
  creating bin/setup <<'END'
#!/bin/sh
set -e
#
# Runs all site setup scripts

`dirname $0`/../setup/external.sh
docker-compose exec wordpress /usr/src/app/setup/internal.sh
END
fi

if new_or_overwrite setup/external.sh; then
  creating setup/external.sh <<'END'
#!/bin/sh
set -e

##
## This code will be run during setup, OUTSIDE the container.
##
## Because `whippet` running inside the container wouldn't be able to connect
## to private repositories.
##

if test -f whippet.json; then
  whippet deps install
fi
END
fi

if new_or_overwrite setup/internal.sh; then
  creating setup/internal.sh <<'END'
#!/bin/sh
set -e

##
## This code will be run during setup, INSIDE the container.
##

##############
#Â Config
##############
title="Your site title here"
theme=your-theme-slug
plugins="a-space-separated list-of plugins-to-activate or use-*-to-activate-all"
content=/usr/src/app/setup/content

wp core !!!INSTALLTYPE!!! --skip-email --admin_user=admin --admin_password=admin --admin_email=admin@localhost.invalid --url=http://localhost --title="$title"

if [ "$plugins" = "*" ]; then
  wp plugin activate --all !!!ACTIVATIONTYPE!!!
else
  for plugin in $plugins
  do
    if wp plugin is-installed $plugin
    then
      wp plugin activate $plugin !!!ACTIVATIONTYPE!!!
    else
      echo "\033[96mWarning:\033[0m Plugin '"$plugin"' could not be found. Have you installed it?"
    fi
  done
fi

if wp theme is-installed $theme
then
  !!!THEMEENABLE!!!
  wp theme activate $theme
else
  echo "\033[96mWarning:\033[0m Theme '"$theme"' could not be found. Have you installed it?"
fi

import() {
  for file in $content/*.xml
  do
    echo "Importing $file..."
    wp import $file --authors=skip
  done
}

if [ "$(ls -A $content)" ]
then
  if wp plugin is-installed wordpress-importer
  then
    wp plugin activate wordpress-importer
    import
  else
    echo "WordPress Importer not installed... installing now"
    wp plugin install wordpress-importer --activate
    import
    wp plugin uninstall wordpress-importer --deactivate
  fi
else
  echo "No content to be imported"
fi

END

  if $MULTISITE = true; then
    sed -i.bak -e 's/!!!INSTALLTYPE!!!/multisite-install/g' setup/internal.sh
    sed -i.bak -e 's/!!!ACTIVATIONTYPE!!!/--network/g' setup/internal.sh
    sed -i.bak -e 's/!!!THEMEENABLE!!!/wp theme enable --network $theme/g' setup/internal.sh
    rm setup/internal.sh.bak
    makedir config
    if new_or_overwrite config/server.php; then
      creating_noexec config/server.php <<'END'
<?php
    if(!defined('MULTISITE')) {
        define( 'MULTISITE', true );
    }
    if(!defined('SUBDOMAIN_INSTALL')) {
        define( 'SUBDOMAIN_INSTALL', false );
    }
    $base = '/';
    if(!defined('DOMAIN_CURRENT_SITE')) {
        define( 'DOMAIN_CURRENT_SITE', 'localhost' );
    }
    if(!defined('PATH_CURRENT_SITE')) {
        define( 'PATH_CURRENT_SITE', '/' );
    }
    if(!defined('SITE_ID_CURRENT_SITE')) {
        define( 'SITE_ID_CURRENT_SITE', 1 );
    }
    if(!defined('BLOG_ID_CURRENT_SITE')) {
        define( 'BLOG_ID_CURRENT_SITE', 1 );
    }

END
    fi

  else
    sed -i.bak -e 's/!!!INSTALLTYPE!!!/install/g' setup/internal.sh
    sed -i.bak -e 's/!!!ACTIVATIONTYPE!!!//g' setup/internal.sh
    sed -i.bak -e 's/!!!THEMEENABLE!!!//g' setup/internal.sh
    rm setup/internal.sh.bak
  fi
fi
